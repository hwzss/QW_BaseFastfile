fastlane_version "2.62.0"

default_platform :ios

platform :ios do

  ENV['FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT'] = '60'
  ENV['FASTLANE_XCODEBUILD_SETTINGS_RETRIES'] = '10'

  desc "Upload an release ipa to TestFilght"
  lane :qw_release do |op|

      upload_ipa_to_testfltght(
        release: true,
        pod_install: op[:pod_install],
        version: op[:version],
        ipa_out_put_dir: op[:ipa_out_put_dir],
        scheme_name: op[:scheme_name],
        auto_increment_version: op[:auto_increment_version]
      )
   
  end

  desc "Upload an debug ipa to TestFilght"
  lane :qw_debug do |op|

      upload_ipa_to_testfltght(
        release: true,
        pod_install: op[:pod_install],
        version: op[:version],
        ipa_out_put_dir: op[:ipa_out_put_dir],
        scheme_name: op[:scheme_name],
        auto_increment_version: op[:auto_increment_version],
        build_num: op[:build_num]
      )
     
  end

  lane :upload_ipa_to_testfltght do |op|
      
      puts "#{op[:build_num]}"
      puts "#{op[:auto_increment_version]}"
      puts "#{op[:release]}"
      puts "#{op[:pod_install]}"
      puts "#{op[:version]}"
      puts "#{op[:scheme_name]}"
      puts "#{op[:ipa_out_put_dir]}"
      puts "@@@@@@@@@@@@@@@@@@@@@@@"
      is_release = op[:release]

      cocoapods if op[:pod_install]
 
      version_number = verify_version_lane version:op[:version]                  

      unless Dir.exist?(File.expand_path("#{out_put_dir}"))
          UI.error("#{out_put_dir} è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·å¡«å†™æ­£ç¡®çš„æ‰“åŒ…è·¯å¾„")   
          next
      end 

      version_number = get_version_number  unless version_number
    
      String.include(VersionFactory)
      #è¡¥é½A.B.Cæ ¼å¼
      version_number = version_number.formatABC
      version_number = version_number.increment if op[:auto_increment_version]
      puts "version_number:#{version_number}"
      version_number = increment_version_number(version_number: version_number)

      build_number = op[:build_num]
      unless op[:auto_increment_version] && op[:version] && build_number
        # if version number not be givend and can not auto increment then auto increment build number
        # build number not be givend       
        build_number = get_build_number 
        String.include(BuildNumberFactory)        
        build_number = build_number.formatABC
        build_number = build_number.incrementBuild        
      end

      build_number.is_build_avalable
      puts "build_number:#{build_number}"
      increment_build_number(build_number: build_number)
      
            
      #out ipa file path
      out_put_dir = verify_ipa_out_put_dir_lane  ipa_out_put_dir:op[:ipa_out_put_dir]
      sub_dir_name = is_release ? "release" : "debugBeta"
      full_output_dir = "#{out_put_dir}/#{sub_dir_name}"

      Dir.mkdir(File.expand_path("#{full_output_dir}")) unless Dir.exist?(File.expand_path("#{full_output_dir}"))

      out_ipa_name = is_release ? "release_#{version_number}_build_#{build_number}" : "debugBeta_#{version_number}_build_#{build_number}"

      gym_configuration = is_release ? "Release" : "Debug"

      scheme_name = verify_shceme_lane scheme_name:op[:scheme_name]
      # puts "scheme_name:#{scheme_name}"
      gym(
        scheme: scheme_name,
        output_directory: full_output_dir,
        silent: true,
        clean: false,
        configuration: gym_configuration,
        output_name: out_ipa_name,
        # export_xcargs: "-allowProvisioningUpdates",
      ) 
      pilot(
        ipa:"#{full_output_dir}/#{out_ipa_name}.ipa"
      ) 
  end 

  desc "æ£€æµ‹versionå‚æ•°,ä¸å­˜åœ¨æ—¶å°±æç¤º"
  lane :verify_version_lane do |options|
    
      unless options[:version]
        UI.message " ************************************************
         *  â° æ‚¨æœªè¾“å…¥ipaçš„ç‰ˆæœ¬ï¼Œå°†è‡ªåŠ¨æ ¹æ®é¡¹ç›®versionè¿›è¡Œè‡ªå¢
         *  æ‚¨å¯ä»¥é€šè¿‡ä¼ å…¥versionæ¥æŒ‡å®šç”Ÿæˆç‰¹å®šçš„ç‰ˆæœ¬å·
         *  æ¯”å¦‚: fastlane release version:1.0.0   
         ************************************************"
      end
      options[:version]
  end

  desc "æ£€æµ‹schemeï¼Œä¸å­˜åœ¨æ—¶æç¤ºå¯è®¾ç½®"
  lane :verify_shceme_lane do |options|
      unless options[:scheme_name]
          UI.message " ************************************************
         *  â° æ‚¨æœªæŒ‡å®šç‰¹å®šçš„scheme,ç³»ç»ŸXcoudeBulid å°†åˆ—å‡ºæ‰€æœ‰schemeè®©ä½ é€‰æ‹©
         *  æ‚¨å¯ä»¥é€šè¿‡ä¼ å…¥scheme_nameæ¥æŒ‡å®šshceme
         *  æ¯”å¦‚: fastlane release scheme_name:\"cloudIM\" 
         ************************************************"
      end
      options[:scheme_name]
  end
  desc "æ£€æµ‹ipaæ‰“åŒ…è·¯å¾„ï¼Œæœªè®¾ç½®æ—¶ï¼Œè¦æ±‚è¾“å…¥è·¯å¾„"
  lane :verify_ipa_out_put_dir_lane do |options|
       unless options[:ipa_out_put_dir]
        UI.message " ************************************************
         *  âŒ æœªè®¾å®šipaæ‰“åŒ…è·¯å¾„,å¿…é¡»è®¾å®šä¸€ä¸ªå½“å‰çš„ipaæ‰“åŒ…è·¯å¾„ï¼Œå¦åˆ™ipaå°†æ‰“å‡ºåœ¨å½“å‰é¡¹ç›®è·¯å¾„
         *  æ‚¨å¯ä»¥é€šè¿‡ä¼ å…¥ipa_out_put_diræ¥æŒ‡å®šè·¯å¾„
         *  æ¯”å¦‚: fastlane release ipa_out_put_dir:\"~/desketop/æ‰“åŒ…\"   
         ************************************************"
        options[:ipa_out_put_dir] = UI.input("è¯·è¾“å…¥æ‰“åŒ…è·¯å¾„:")
      end
      options[:ipa_out_put_dir]
  end

end


module BuildNumberFactory
  
  def is_build_avalable
      unless self =~ /^\d{1,}$/
          puts "build_numberæ ¼å¼ä¸å¯¹ï¼Œæ­£ç¡®æ ¼å¼åº”è¯¥ä¸ºæ•´æ•°"
      end
  end
  
  def formatBuildNumber
      build_arrs = self.split('.').map(&:to_i);
      build_number = build_arrs.last;
      build_number = 0 unless build_number;
  end

  def incrementBuild
      build_arrs = self.split('.').map(&:to_i);
      build_number = build_arrs.last;
      if build_number
        build_number++
      else
        build_number = 0
      end

      build_number
  end
  
end

# æŒ‡å®šç»™Stringå®ä¾‹
module VersionFactory

def is_available

  unless self =~ /^\d{1,}.\d.\d$/
    puts "version_numberæ ¼å¼ä¸å¯¹ï¼Œæ­£ç¡®æ ¼å¼åº”è¯¥ä¸º A.B.C "
    return false
  end
  true  
end

# æ»¡è¶³ï¼^\d{1,}*ï¼çš„å€¼æ ¼å¼æˆ A.B.Cçš„å½¢å¼
def formatABC

  version_arrs = self.split('.')
  
  version_arrs << "0" if version_arrs.count == 1
  version_arrs << "0" if version_arrs.count == 2

  temp_version_number = version_arrs[0..2].join('.')


end


# self.split('.').join('').to_i + 1
#ä¸‘å¤§äº†ï¼ï¼ï¼,å…¶å®ğŸ‘‡ä¸‹é¢çš„æ–¹æ³•å’Œè¿™ä¸€å¥ä»£ç æ•ˆæœä¸€æ ·ï¼Œself.split('.').join('').to_i + 1 å‘å•Šï¼Œå†™äº†é‚£ä¹ˆå¤š

# å°†æ»¡è¶³æ­£åˆ™/^\d{1,}.\d.\d$/ çš„å€¼è¿›è¡Œè‡ªå¢1
def increment

  version_arrs = self.split('.').map(&:to_i)

  if self =~ /^\d{1,}.[0-8].9$|^\d{1,}.[0-8].\d{2,}$/
  
     version_arrs[1] = version_arrs[1] + 1
     version_arrs[2] = 0
  
  elsif self =~ /^\d{1,}.9.9$|\d{1,}.\d{2,}.\d{2,}$/
     
     version_arrs[0] = version_arrs[0] + 1
     version_arrs[1] = 0
     version_arrs[2] = 0

  else

      version_arrs[2] = version_arrs[2] + 1

  end

  version_arrs[0..2].join('.')

end


end